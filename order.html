<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UltraPrints | Order Confirmation</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary-color': '#C026D3', /* Fuchsia 600 - Main accent */
                        'secondary-color': '#4C1D95', /* Violet 900 - Darker accent */
                        'accent-light': '#FBCFE8' /* Pink 200 - For text contrast */
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        /* Base styles for Glassmorphism */
        body {
            font-family: 'Inter', sans-serif;
            background: #4A0E4B; 
            background-image: radial-gradient(circle at 10% 20%, #A21CAF 0%, #4A0E4B 90%);
            min-height: 100vh;
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 10px 40px 0 rgba(192, 38, 211, 0.35);
            border-radius: 1.75rem;
            color: white; 
            transition: all 0.3s ease-in-out;
        }

        /* Essential styling for inputs to be visible and interactive */
        input[type="text"], input[type="email"], input[type="tel"], input[type="file"] {
            background: rgba(255, 255, 255, 0.15); /* Semi-transparent background */
            border: 1px solid rgba(255, 255, 255, 0.4);
            color: white; /* Ensure text is visible */
            padding: 0.75rem;
            border-radius: 0.75rem;
            transition: border-color 0.2s;
        }
        input::placeholder {
            color: rgba(255, 255, 255, 0.6); /* Visible placeholder */
        }
        input:focus {
            outline: none;
            border-color: #C026D3; /* primary-color */
            box-shadow: 0 0 0 3px rgba(192, 38, 211, 0.5);
        }

        /* File Input Area Styling */
        #imageUploadArea {
            border-style: dashed;
            border-width: 2px;
            border-color: rgba(255, 255, 255, 0.5);
            transition: border-color 0.3s;
        }
        #imageUploadArea:hover {
            border-color: #C026D3; /* primary-color */
        }
        #imageUploadInput {
            opacity: 0;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }
    </style>
</head>
<body class="flex flex-col items-center justify-start p-4 md:p-8">

    <!-- Back to Home Link -->
    <a href="index.html" class="absolute top-4 left-4 text-white hover:text-accent-light flex items-center transition-colors">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10 19l-7-7m0 0l7-7m-7 7h18" /></svg>
        Back to Home
    </a>

    <!-- Main Order Form Container -->
    <main class="w-full max-w-4xl pt-8 pb-16">
        <h1 class="text-4xl md:text-5xl font-extrabold text-white text-center mb-6">Confirm Your UltraPrint Order</h1>
        <p class="text-center text-accent-light mb-12">Please confirm your details and image to finalize your order. You will receive an SMS confirmation shortly.</p>

        <!-- Glass Card Form -->
        <div id="formContainer" class="glass-card p-6 sm:p-10">

            <!-- The Form (Now correctly structured and visible) -->
            <form id="orderForm" class="space-y-10">

                <!-- STEP 1: Contact Details -->
                <section>
                    <h2 class="text-3xl font-bold mb-6 text-primary-color">1. Your Contact Details</h2>
                    <div class="space-y-6">
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- First Name -->
                            <div>
                                <label for="firstName" class="block text-lg font-medium mb-2">First Name</label>
                                <input type="text" id="firstName" name="firstName" required placeholder="John"
                                       class="w-full">
                            </div>
                            <!-- Last Name -->
                            <div>
                                <label for="lastName" class="block text-lg font-medium mb-2">Last Name</label>
                                <input type="text" id="lastName" name="lastName" required placeholder="Doe"
                                       class="w-full">
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Phone Number -->
                            <div>
                                <label for="phone" class="block text-lg font-medium mb-2">Phone Number</label>
                                <input type="tel" id="phone" name="phone" required placeholder="(555) 123-4567"
                                       class="w-full">
                            </div>
                            <!-- Email Address -->
                            <div>
                                <label for="email" class="block text-lg font-medium mb-2">Email Address</label>
                                <input type="email" id="email" name="email" required placeholder="john.doe@email.com"
                                       class="w-full">
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Separator -->
                <div class="h-px bg-white/20"></div>

                <!-- STEP 2: Image Upload and Preview -->
                <section>
                    <h2 class="text-3xl font-bold mb-6 text-primary-color">2. Upload Image</h2>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 items-start">
                        
                        <!-- Upload Area -->
                        <div id="imageUploadArea" class="relative p-6 text-center rounded-xl bg-white/10 flex flex-col items-center justify-center min-h-[200px] transition-all duration-300">
                            <input type="file" id="imageUploadInput" accept="image/*" onchange="handleImageUpload(event)" required aria-label="Upload Image">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-white/70 mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" /></svg>
                            <p class="text-lg font-semibold text-white">Drag & drop or Click to Upload</p>
                            <p class="text-sm text-accent-light">Max file size: 10MB. Formats: JPG, PNG, TIFF.</p>
                        </div>

                        <!-- Preview Area -->
                        <div class="bg-white/10 rounded-xl p-4 flex items-center justify-center min-h-[200px]">
                            <img id="imagePreview" src="https://placehold.co/300x200/4C1D95/FFFFFF?text=Image+Preview" alt="Image Preview" class="max-w-full max-h-96 rounded-lg shadow-xl border-2 border-primary-color transition-all duration-300">
                        </div>
                    </div>
                    <p id="uploadMessage" class="mt-4 text-center text-green-300 hidden font-medium">Image uploaded successfully! Ready to confirm order.</p>
                </section>

                <!-- Separator -->
                <div class="h-px bg-white/20"></div>

                <!-- SUBMIT BUTTON AND LOADING -->
                <div class="text-center">
                    <button type="submit" id="submitButton"
                        class="w-full md:w-auto py-4 px-12 bg-white text-secondary-color text-xl font-extrabold rounded-full shadow-2xl hover:bg-pink-100 transition duration-300 ease-in-out transform hover:scale-105 ring-4 ring-white/50">
                        Confirm and Place UltraPrint Order
                    </button>
                    <p id="loadingMessage" class="mt-4 text-white text-lg hidden font-semibold flex items-center justify-center">
                        <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                        Processing your order...
                    </p>
                </div>
            </form>
            <!-- End of Form -->

        </div>
    </main>

    <!-- Success Message Modal (Hidden by default) -->
    <div id="successModal" class="hidden fixed inset-0 bg-black bg-opacity-70 z-50 flex items-center justify-center p-4">
        <div class="glass-card p-10 max-w-lg w-full text-center transform scale-100 transition-all duration-500">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-20 w-20 mx-auto text-primary-color" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg>
            <h3 class="text-3xl font-bold mt-4 mb-2">Order Confirmed!</h3>
            <p id="orderIdDisplay" class="text-xl font-mono text-primary-color bg-white/10 p-2 rounded-lg my-3 break-all">ID: ABC-123</p>
            <p class="text-lg text-accent-light">Thank you for choosing UltraPrints. You will soon receive a confirmation SMS with your Order ID.</p>
            <button onclick="window.location.href = 'index.html';"
                    class="mt-6 py-2 px-6 bg-primary-color rounded-full text-white font-semibold hover:bg-secondary-color transition duration-150">
                Return to Home
            </button>
        </div>
    </div>


    <!-- JavaScript Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, addDoc, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Global variable to store the Base64 image string for submission
        let base64Image = null; 

        // --- FIREBASE CONFIG (Hardcoded as per user request) ---
        // NOTE: This hardcoded configuration may be the source of the auth/configuration-not-found error 
        // in this environment, but we are adhering to your strict instruction to use it.
        const firebaseConfig = {
            apiKey: "AIzaSyD1rLCcwyFrIKd20YjxpYbX8VbvizArxEo",
            authDomain: "ultraprints-61820.firebaseapp.com",
            projectId: "ultraprints-61820",
            storageBucket: "ultraprints-61820.firebasestorage.app",
            messagingSenderId: "142922896839",
            appId: "1:142922896839:web:28b4ee378142dc690f35e2",
            measurementId: "G-4PCFERE5G5"
        };
        // ------------------------------------

        // Global Firebase instances
        let db, auth;
        const form = document.getElementById('orderForm');
        const submitButton = document.getElementById('submitButton');
        const loadingMessage = document.getElementById('loadingMessage');
        const imageUploadInput = document.getElementById('imageUploadInput');

        /**
         * Initializes Firebase and authenticates the user using the hardcoded config.
         */
        async function initializeFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // Use global token if available (to satisfy environment), otherwise sign in anonymously
                const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                console.log("Firebase initialized and authenticated successfully.");

            } catch (error) {
                console.error("Firebase initialization failed:", error);
            }
        }

        /**
         * Reads the image file as a Base64 Data URL and stores it globally.
         * @param {Event} event - The change event from the file input.
         */
        window.handleImageUpload = function(event) {
            const file = event.target.files[0];
            const preview = document.getElementById('imagePreview');
            const message = document.getElementById('uploadMessage');
            const placeholder = 'https://placehold.co/300x200/4C1D95/FFFFFF?text=Image+Preview';
            base64Image = null; // Clear previous image data

            if (file) {
                // The 10MB client-side limit helps reduce the risk of exceeding the 1MB Firestore limit, 
                // but does not guarantee it.
                if (file.size > 10 * 1024 * 1024) { 
                    message.textContent = "Error: File is too large (10MB max).";
                    message.classList.remove('text-green-300');
                    message.classList.add('text-red-400');
                    message.classList.remove('hidden');
                    preview.src = placeholder;
                    imageUploadInput.value = ''; // Clear file input
                    return;
                }

                const reader = new FileReader();
                reader.onload = function(e) {
                    base64Image = e.target.result; // Store the Base64 Data URL
                    preview.src = base64Image;

                    message.textContent = "Image loaded successfully! Ready to confirm order.";
                    message.classList.remove('text-red-400');
                    message.classList.add('text-green-300');
                    message.classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            } else {
                preview.src = placeholder;
                message.classList.add('hidden');
            }
        }

        /**
         * Handles the form submission: saves Base64 image and metadata to Firestore.
         * Cloudinary logic is entirely removed.
         * @param {Event} event - The form submit event.
         */
        async function handleOrder(event) {
            event.preventDefault();
            
            submitButton.disabled = true;
            submitButton.classList.add('opacity-50', 'cursor-not-allowed');
            loadingMessage.classList.remove('hidden');

            const file = imageUploadInput.files[0];
            const formData = new FormData(form);

            try {
                if (!db || !auth) {
                    await initializeFirebase();
                }

                // 1. Skip external upload and check for Base64 data
                if (!file || !base64Image) {
                    throw new Error("Please select an image file to upload.");
                }
                
                // 2. SAVE ORDER METADATA TO FIRESTORE
                const userId = auth.currentUser?.uid || crypto.randomUUID();
                // Use the hardcoded projectId for the app ID since __app_id is unreliable when hardcoding config
                const appId = firebaseConfig.projectId; 

                const orderData = {
                    firstName: formData.get('firstName'),
                    lastName: formData.get('lastName'),
                    phone: formData.get('phone'),
                    email: formData.get('email'),
                    imageBase64: base64Image, // <-- SAVING THE BASE64 STRING DIRECTLY
                    userId: userId,
                    timestamp: new Date().toISOString(),
                    status: 'Pending Confirmation SMS'
                };

                const orderCollectionRef = collection(db, `artifacts/${appId}/public/data/orders`);
                const docRef = await addDoc(orderCollectionRef, orderData);

                // 3. DISPLAY SUCCESS MESSAGE
                document.getElementById('orderIdDisplay').textContent = `ID: ${docRef.id}`;
                document.getElementById('successModal').classList.remove('hidden');
                document.getElementById('formContainer').classList.add('hidden');

            } catch (error) {
                console.error("Order submission failed:", error.message || error);
                
                // Check for potential Firestore size limit error
                let errorMessage = error.message || 'Unknown error.';
                if (errorMessage.includes('document size')) {
                    errorMessage = "Failed: Image is too large. Please try a smaller image (under 1MB).";
                }
                
                // Use custom alert/modal instead of window.alert()
                const alertContent = document.createElement('div');
                alertContent.innerHTML = `<p class="text-red-400 font-semibold mb-4">Error: ${errorMessage}</p>`;
                
                // Show a temporary error message in the form container
                document.getElementById('formContainer').insertAdjacentElement('beforebegin', alertContent);
                setTimeout(() => alertContent.remove(), 5000); 

            } finally {
                // Reset form state on success or error
                submitButton.disabled = false;
                submitButton.classList.remove('opacity-50', 'cursor-not-allowed');
                loadingMessage.classList.add('hidden');
            }
        }

        // Initialize Firebase on load
        initializeFirebase();
        
        // Attach event listener
        form.addEventListener('submit', handleOrder);

    </script>
</body>
</html>
